---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import Top from '../components/top.astro';
import Pulsador from '../components/pulsador.astro';
import Canciones from '../components/canciones.astro';
import InsertarCanciones from '../components/insertar-canciones.astro';
import { supabaseServer } from '../db/supabaseServer.js';
import RecopilatorioSongs from '../components/recopilatorio-songs.astro';
import TablaJugadores from '../components/tabla-jugadores.astro';

const supabase = supabaseServer(Astro);
const { data: { user } } = await supabase.auth.getUser();

let role = 'guest';
if (user) {
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single();
  role = profile?.role ?? 'user';
}

if (role !== 'admin') {
  return Astro.redirect('/403');
}
---


<Layout>
  <Top />
  
  <nav class="nav-links">
    <a href="/">Volver al Inicio</a>
  </nav>

  <main>
    <div class="card">
      <h2 class="text-center mb-4">Panel de Administraci√≥n</h2>
      <RecopilatorioSongs />
    </div>
    
    <div class="card">
      <h2 class="text-center mb-4">Canciones</h2>
      <InsertarCanciones />
    </div>

    <div class="card">
      <h2 class="text-center mb-4">Tabla de los jugadores activos</h2>
      <TablaJugadores />
    </div>
    
  </main>
</Layout>