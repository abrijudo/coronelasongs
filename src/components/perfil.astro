---
import { supabaseServer } from "../db/supabaseServer.js";

// Renderiza sólo si hay usuario (SSR)
const supabase = supabaseServer(Astro);
const { data: { user } } = await supabase.auth.getUser();
const isLoggedIn = !!user;
---

{isLoggedIn && (
  <>
    <!-- Botón para abrir el modal -->
    <button id="openProfileBtn" class="btn-profile" aria-label="Abrir mi perfil">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
        <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4z"/>
      </svg>
    </button>

    <!-- Modal de Perfil -->
    <div id="profileModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-content">
        <button id="closeModalBtn" class="btn-close" aria-label="Cerrar modal">&times;</button>
        <h2 id="modal-title" class="modal-title">Mi Perfil</h2>

        <div class="form-group">
          <label for="profileEmail" class="form-label">Email</label>
          <input type="email" id="profileEmail" class="form-input" readonly />
        </div>

        <div class="form-group">
          <label for="profileName" class="form-label">Nombre de usuario</label>
          <input type="text" id="profileName" class="form-input" placeholder="Ej. juan.perez" />
        </div>

        <div class="button-group">
          <button id="changePasswordBtn" class="btn btn-secondary">
            <span class="btn-icon">🔐</span><span>Cambiar Contraseña</span>
          </button>
          <button id="saveProfileBtn" class="btn btn-primary">
            <span class="btn-icon">💾</span><span>Guardar Cambios</span>
          </button>
          <button id="logoutBtn" class="btn btn-secondary">
            <span class="btn-icon">🚪</span><span>Cerrar sesión</span>
          </button>
        </div>
      </div>
    </div>

    <style>
      :root {
        --color-primary:#10b981; 
        --color-primary-dark:#059669;
        --color-secondary:#374151;
        --color-bg:#1f2937;
        --color-bg-light:#111827;
        --color-text:#f3f4f6;
        --color-muted:#9ca3af;
        --shadow-md:0 4px 6px rgba(0,0,0,0.5);
        --radius-md:12px;
        --transition:all .2s ease;
        --font-sans:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      }

      .btn-profile {
        display:flex; align-items:center; justify-content:center; 
        background-color:var(--color-primary);
        color:#fff; border:none; width:44px; height:44px; border-radius:50%; cursor:pointer;
        box-shadow:var(--shadow-md); transition:var(--transition); 
        position:fixed; top:24px; right:24px; z-index:100;
      }
      .btn-profile:hover { background-color:var(--color-primary-dark); transform:scale(1.05); }

      .modal { 
        display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.7); 
        z-index:1000; animation:fadeIn .25s ease; 
      }
      @keyframes fadeIn { from{opacity:0} to{opacity:1} }

      .modal-content {
        position:relative; background:var(--color-bg-light); color:var(--color-text);
        width:90%; max-width:480px; margin:10% auto; padding:32px;
        border-radius:var(--radius-md); box-shadow:var(--shadow-md);
        font-family:var(--font-sans); animation:slideUp .3s ease;
      }
      @keyframes slideUp { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }

      .btn-close {
        position:absolute; top:16px; right:16px; font-size:24px; 
        background:none; border:none; color:var(--color-muted); cursor:pointer;
      }
      .btn-close:hover { color:var(--color-text); }

      .modal-title { font-size:1.5rem; font-weight:600; margin-bottom:24px; text-align:center; }

      .form-group { margin-bottom:20px; }
      .form-label { display:block; font-size:.9rem; font-weight:500; margin-bottom:6px; color:var(--color-muted); }

      .form-input {
        width:100%; padding:12px 16px; font-size:1rem; border:1px solid #374151;
        border-radius:var(--radius-md); background-color:var(--color-bg);
        color:var(--color-text); transition:var(--transition);
      }
      .form-input:focus { outline:none; border-color:var(--color-primary); box-shadow:0 0 0 2px rgba(16,185,129,0.3); }

      .button-group { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
      .btn {
        display:flex; align-items:center; gap:8px; padding:10px 18px; 
        font-size:.95rem; font-weight:500; border:none; border-radius:var(--radius-md); 
        cursor:pointer; transition:var(--transition);
      }
      .btn-primary { background-color:var(--color-primary); color:#fff; }
      .btn-primary:hover { background-color:var(--color-primary-dark); }

      .btn-secondary { background-color:var(--color-secondary); color:#fff; }
      .btn-secondary:hover { background-color:#1f2937; }
    </style>

    <script>
      import("../scripts/perfil.js").then(mod => mod.initPerfil());
    </script>
  </>
)}
