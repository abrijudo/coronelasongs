---
export const prerender = false;
import Timer from "../components/timer.astro";
---

<!-- Cartel de fuera del juego -->
<div id="pp-locked" class="pp-locked" hidden>
  <div class="pp-locked__card">
    <h2>ðŸš« No estÃ¡s dentro del juego</h2>
    <p>
      Cuando el organizador te aÃ±ada al juego,
      esta pÃ¡gina se activarÃ¡ automÃ¡ticamente.
    </p>
  </div>
</div>

<!-- Contenido del participante (arranca oculto, se muestra si jugando=TRUE) -->
<section id="pp-root" class="pp-wrap" hidden>
  <!-- TÃ­tulo con el usuario logueado -->
  <h2 class="pp-title">
    Participante:
    <span class="turn-title" id="pp-user-name">â€”</span>
  </h2>

  <div class="pp-grid">
    <!-- Marcador -->
    <div class="pp-card">
      <h3 class="pp-h3">Marcador</h3>
      <table class="pp-table" aria-label="Marcador de jugadores">
        <thead>
          <tr><th>Jugador</th><th>Puntos</th></tr>
        </thead>
        <tbody id="pp-body"></tbody>
      </table>
    </div>

    <!-- Tu turno + botÃ³n + reloj -->
    <div class="pp-card pp-center">
      <h3 class="pp-h3">Tu turno</h3>

      <div class="turno" id="turno-box">
        <span class="turno__label">Turno de:</span>
        <span class="turno__name" data-turn-name>â€”</span>
        <span class="turno__mine" hidden>Â¡Â¡Â¡TU TURNO!!!</span>
      </div>

      <button id="pp-buzz" class="pp-btn">Â¡Pulsar!</button>
      <p id="pp-hint" class="pp-hint"></p>

      <div class="timer-slot"><Timer /></div>
    </div>
  </div>
</section>

<style>
:root { color-scheme: dark; }

body {
  background:#0b0f1a;
  color:#e5e7eb;
}

/* ====== Cartel fuera del juego ====== */
.pp-locked{max-width:900px;margin:2rem auto;padding:0 1rem}
.pp-locked__card{
  background:#1f2937;border:1px solid #374151;border-radius:16px;
  box-shadow:0 8px 22px rgba(0,0,0,.25);padding:24px;text-align:center
}
.pp-locked__card h2{margin:0 0 .5rem;font-weight:800;color:#f87171}
.pp-locked__card p{margin:0;color:#9ca3af}

/* ====== LAYOUT ====== */
.pp-wrap { max-width: 950px; margin: 2rem auto; padding: 0 1rem; }
.pp-title { text-align: center; font-size: 2rem; color:#f3f4f6; margin-bottom: 2rem; font-weight: 800; }
.pp-title .turn-title { margin-left: .5rem; color:#93c5fd; letter-spacing:.4px; }

.pp-grid { display: grid; gap: 1.5rem; grid-template-columns: 2fr 1fr; }
@media (max-width: 860px) { .pp-grid { grid-template-columns: 1fr; } }

.pp-card { background:#111827; border-radius: 16px; border: 1px solid #374151; box-shadow: 0 6px 18px rgba(0,0,0,.4); padding: 1.5rem; }
.pp-center { display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; }

.pp-h3 { margin-bottom: 1rem; color:#93c5fd; font-size:1.2rem; font-weight:700; }

/* ====== BOTONES / TEXTOS ====== */
.pp-btn{
  display:inline-flex; align-items:center; justify-content:center;
  background:#2563eb; color:#fff; border:none; border-radius:12px;
  padding:1rem 1.5rem; font-weight:700; cursor:pointer; min-width:200px;
  box-shadow:0 6px 18px rgba(0,0,0,.4);
  transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
}
.pp-btn:hover{ background:#1d4ed8; transform: translateY(-2px); }
.pp-btn:disabled{ opacity:.6; cursor:not-allowed; }

.pp-hint{ margin-top:1rem; color:#fbbf24; font-size:.95rem; }
.timer-slot{ margin-top:14px; }

.turno{ margin:6px 0 10px; font-weight:800; color:#e5e7eb; }
.turno__label{ opacity:.7; margin-right:.35rem; }
.turno__name{ letter-spacing:.5px; }

/* ====== TABLA ====== */
.pp-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 12px;
  text-align: center;
  font-size: 1rem;
}
.pp-table thead th {
  background: #1f2937; color: #f9fafb; font-weight: 700;
  text-transform: uppercase; font-size: .95rem; letter-spacing: .5px;
  padding: 1rem; border-radius: 12px;
}
.pp-table tbody tr.pp-row { background: #111827; box-shadow: 0 6px 18px rgba(0,0,0,.4); }
.pp-table tbody tr.pp-row td { border-bottom: none; padding: 14px 16px; vertical-align: middle; color:#e5e7eb; }
.pp-table tbody tr.pp-row td:first-child { border-radius: 12px 0 0 12px; }
.pp-table tbody tr.pp-row td:last-child  { border-radius: 0 12px 12px 0; }
.pp-table .empty{ text-align:center; color:#9ca3af; padding:1rem; font-style:italic; }
.pp-row.me { box-shadow: 0 0 0 2px #2563eb; }
</style>

<!-- ====== Scripts ====== -->
<script>
  import("../scripts/participantes.js").then(mod => {
    mod.initParticipantes?.();

    // comprobaciÃ³n al recargar â†’ si ya estaba pulsado mostrar mensaje
    setTimeout(async () => {
      const { supabase } = await import("../db/supabase.js");
      const { data: { user } } = await supabase.auth.getUser();
      const myName = user?.user_metadata?.name || user?.email?.split("@")[0] || null;
      if (!myName) return;
      const { data } = await supabase.from("pulsador").select("activado").eq("usuario", myName).maybeSingle();
      if (data?.activado) {
        const $hint = document.getElementById("pp-hint");
        if ($hint) $hint.textContent = "Ya has pulsado";
      }
    }, 800);
  });
</script>
